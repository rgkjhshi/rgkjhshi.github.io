<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="十分钟了解BIO、NIO、AIO, 编程技术, Java, 逆水行舟" />
    <meta name="description" content="十分钟了解BIO、NIO、AIO, 编程技术, Java, 本文内容涉及同步与异步, 阻塞与非阻塞, BIO、NIO、AIO等概念" />

    <title>逆水行舟</title>

    <!-- ico图标 -->
    <link rel="shortcut icon" type="image/x-icon" media="screen" href="/static/favicon.ico" />
    <!-- 搜索引擎收入相关 -->
    <link rel="canonical" href="http://loveshisong.cn/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-06-25-%E5%8D%81%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3BIO-NIO-AIO.html" />
    <!-- rss输出源 -->
    <link rel="alternate" type="application/rss+xml" title="逆水行舟" href="http://loveshisong.cn/feed.xml"  />
    <!-- jquery -->
    <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.11.3/jquery.js"></script>
    <!-- qrcode -->
    <script type="text/javascript" src="/static/js/jquery.qrcode.min.js"></script>
    <!-- UK core js -->
    <script type="text/javascript" src="/static/js/uikit.min.js"></script>
    <!-- quietflow -->
    <!-- <script type="text/javascript" src="http://loveshisong.cn/static/js/quietflow.min.js"></script> -->
    <!-- UK sticky -->
    <script type="text/javascript" src="/static/js/components/sticky.min.js"></script>
    <!-- 本站js -->
    <script type="text/javascript" src="/static/js/script.js"></script>
    <!-- uk css-->
    <link rel="stylesheet" type="text/css" href="/static/css/uikit.min.css" />
    <!-- 基本样式 -->
    <link rel="stylesheet" type="text/css" href="/static/css/base.css" />
    <!-- 本站样式 -->
    <link rel="stylesheet" type="text/css" href="/static/css/main.css" />
    <!-- 代码高亮 -->
    <link rel="stylesheet" type="text/css" href="/static/css/highlight.css" />

    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
        var duoshuoQuery = {
            short_name: "shisong"
        };
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';
            ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共JS代码 end -->
</head>


<body>

    <header class="header" data-uk-sticky>
    <!-- 导航栏 -->
    <div class="uk-container uk-container-center">
        <div class="headwapper">
            <div class="navbar uk-float-left">
                <a class="uk-navbar-brand uk-hidden-small" href="http://loveshisong.cn"> 逆水行舟 -- Michael King's Blog </a>
                <a class="uk-visible-small uk-icon-home uk-icon-large" href="http://loveshisong.cn"></a>
            </div>
            <div class="navbar uk-float-right">
                <ul class="navbar-nav">
                    <li><a href="/pages/archive.html" title="归档" class="uk-icon-folder uk-icon-small"></a></li>
                    <li><a href="/pages/categories.html" title="目录分类" class="uk-icon-list uk-icon-small"></a></li>
                    <li><a href="/pages/tags.html" title="标签" class="uk-icon-tags uk-icon-small"></a></li>
                    <li><a href="/pages/about.html" title="About Me" class="uk-icon-user uk-icon-small"></a></li>
                    <li><a href="https://github.com/rgkjhshi" title="Github" class="uk-icon-github uk-icon-small"></a></li>
                    <li><a href="/feed.xml" title="RSS" class="uk-icon-rss uk-icon-small"></a></li>
                </ul>
            </div>
        <div>
    </div>
</header>
<!-- header end -->


    <div class="uk-container uk-container-center">
        <script type="text/javascript">
jQuery(function(){
	jQuery('#qrcode').qrcode({
        width: 150,
        height: 150,
        text: "http://loveshisong.cn/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-06-25-%E5%8D%81%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3BIO-NIO-AIO.html"
    });
})
</script>
<!-- 日志默认模板 -->
<div class="uk-container content">
    <div class="page-title">
        <h1>十分钟了解BIO、NIO、AIO</h1>
    </div>
    <div class="uk-grid">
        <div  class="uk-width-4-4">
            <div id="qrcode" class="uk-float-right uk-thumbnail"></div>
            <p>本文内容涉及同步与异步, 阻塞与非阻塞, BIO、NIO、AIO等概念</p>

<hr />

<ul id="markdown-toc">
  <li><a href="#section">同步与异步</a></li>
  <li><a href="#section-1">阻塞与非阻塞</a></li>
  <li><a href="#io">IO模型</a>    <ul>
      <li><a href="#bio">BIO</a></li>
      <li><a href="#nio">NIO</a></li>
      <li><a href="#io-1">IO多路复用</a></li>
      <li><a href="#aio">AIO</a></li>
      <li><a href="#section-2">小结</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="section">同步与异步</h2>
<p><code class="highlighter-rouge">同步与异步</code>的概念, 关注的是 <strong>消息通信机制</strong></p>

<ul>
  <li><code class="highlighter-rouge">同步</code>是指发出一个请求, 在没有的到结果之前该请求就不返回结果, 请求返回时, 也就得到结果了.</li>
</ul>

<p>比如洗衣服, 把衣服放在洗衣机里, 没有洗好之前我们一直看着, 直到洗好了才拿出来晾晒.</p>

<ul>
  <li><code class="highlighter-rouge">异步</code>是指发出一个请求后, 立刻得到了回应, 但没有返回结果. 这时我们可以再处理别的事情(发送其他请求), 所以这种方式需要我们通过状态主动查看是否有了结果, 或者可以设置一个回调来通知调用者.</li>
</ul>

<p>比如洗衣服时, 把衣服放到洗衣机里, 我们就可以去做别的事情, 过会儿来看看有没有洗好(通过状态查询); <br />
或者我们设置洗衣机洗完后响铃来通知我们洗好了(回调通知)</p>

<p><strong>注:</strong> 在很多不同场景里都有同步的概念, 但有不同意思, 这里的同步跟java中多线程同步(<code class="highlighter-rouge">synchronized</code>)说的不是一回事儿</p>

<hr />

<h2 id="section-1">阻塞与非阻塞</h2>

<p><code class="highlighter-rouge">阻塞与非阻塞</code>很容易和<code class="highlighter-rouge">同步与异步</code>混淆, 但两者关注点是不一样的. <code class="highlighter-rouge">阻塞与非阻塞</code>关注的是 <strong>程序在等待调用结果时的状态</strong></p>

<ul>
  <li><code class="highlighter-rouge">阻塞</code>是指请求结果返回之前, 当前线程会被挂起(被阻塞), 这时线程什么也做不了</li>
  <li><code class="highlighter-rouge">非阻塞</code>是指请求结果返回之前, 当前线程没有被阻塞, 仍然可以做其他事情.</li>
</ul>

<p><code class="highlighter-rouge">阻塞</code>有个明显的特征就是线程通常是处于<code class="highlighter-rouge">BLOCKED</code>状态(BIO中的<code class="highlighter-rouge">read()</code>操作时, 线程阻塞是JVM配合OS完成的, 此时Java获取到线程的状态仍是<code class="highlighter-rouge">RUNNABLE</code>但它确实已经被阻塞了)</p>

<p>如果要拿<code class="highlighter-rouge">同步</code>来做比较的话, 同步通信方式中的线程在发送请求之后等待结果这个过程中应该处于<code class="highlighter-rouge">RUNNABLE</code>状态, 同步必须一步一步来完成, 就像是代码必须执行完一行才能执行下一行, 所以必须等待这个请求返回之后才可进行下一个请求, 即使等待结果的时间长, 也是在执行这个请求的过程中. 而<code class="highlighter-rouge">异步</code>则不用等上一条执行完, 可以先执行别的代码, 等请求有了结果再来获取结果.</p>

<hr />

<h2 id="io">IO模型</h2>

<p>Java中的IO操作是JVM配合操作系统来完成的. 对于一个IO的读操作, 数据会先被拷贝到操作系统内核的缓冲区中, 然后从操作系统内核的缓冲区拷贝到应用程序的地址空间. 所以整个过程可分为两个阶段:</p>

<ol>
  <li>等待I/O数据准备好. 这取决于IO目标返回数据的速度, 如网络IO时看网速和数据本身的大小.</li>
  <li>数据从内核缓冲区拷贝到进程内.</li>
</ol>

<p>根据这两个阶段, 产生了常见的几种不同的IO模型: <code class="highlighter-rouge">BIO</code>, <code class="highlighter-rouge">NIO</code>, <code class="highlighter-rouge">多路复用IO</code>和<code class="highlighter-rouge">AIO</code>.</p>

<h3 id="bio">BIO</h3>

<p><code class="highlighter-rouge">BIO</code>即<code class="highlighter-rouge">Blocking I/O</code>(阻塞 I/O), BIO整个过程如下图:</p>

<p><img src="/static/images/BIO.png" alt="BIO" title="BIO" /></p>

<p>程序发送请求给内核, 然后由内核去进行通信, 在内核准备好数据之前这个线程是被挂起的, 所以在两个阶段程序都处于挂起状态.</p>

<ul>
  <li>BIO的特点就是在IO执行的两个阶段都被block了</li>
</ul>

<h3 id="nio">NIO</h3>

<p><code class="highlighter-rouge">NIO</code>即<code class="highlighter-rouge">Non-Blocking I/O</code>(非阻塞 I/O), NIO整个过程如下图:</p>

<p><img src="/static/images/NIO.png" alt="NIO" title="NIO" /></p>

<p>与BIO的明显区别是, 发起第一次请求后, 线程并没有被阻塞, 它反复检查数据是否准备好, 把原来大块不能用的阻塞时间分成了许多”小阻塞”(检查), 所以进程不断有机会被执行. 这个检查有没有准备好数据的过程有点类似于”轮询”.</p>

<ul>
  <li>NIO的特点就是程序需要不断的主动询问内核数据是否准备好。第一个阶段非阻塞, 第二个阶段阻塞</li>
</ul>

<h3 id="io-1">IO多路复用</h3>

<p>IO多路复用(<code class="highlighter-rouge">I/O Multiplexing</code>)有<code class="highlighter-rouge">select</code>, <code class="highlighter-rouge">poll</code>, <code class="highlighter-rouge">epoll</code>等不同方式, 它的优点在于单个线程可以同时处理多个网络IO.</p>

<p><code class="highlighter-rouge">NIO</code>中轮询操作是用户线程进行的, 如果把这个任务交给其他线程, 则用户线程就不用这么费劲的查询状态了. <code class="highlighter-rouge">IO多路复用</code>调用系统级别的<code class="highlighter-rouge">select</code>或<code class="highlighter-rouge">poll</code>模型, 由系统进行监控IO状态. select轮询可以监控许多socket的IO请求, 当有一个socket的数据准备好时就可以返回.</p>

<ul>
  <li>select: 注册事件由数组管理, 数组是有长度的, 32位机上限1024, 64位机上限2048. 轮询查找时需要遍历数组.</li>
  <li>poll: 把select的数组采用链表实现, 因此没了最大数量的限制</li>
  <li>epoll方式: 基于事件回调机制, 回调时直接通知进程, 无须使用某种方式来查看状态.</li>
</ul>

<p>多路复用IO过程图:</p>

<p><img src="/static/images/Multiplexing_IO.png" alt="Multiplexing_IO" title="Multiplexing_IO" /></p>

<p>用户线程有一段时间是阻塞的, 从上图来看, 与<code class="highlighter-rouge">NIO</code>很像, 但与NIO不一样的是, select不是等到所有数据准备好才返回, 而是只要有一个准备好就返回, 它的优势在于可以同时处理多个连接. 若连接不是很多的话, 它的效率不一定高, 可能还会更差.</p>

<p><code class="highlighter-rouge">Java 1.4</code>开始支持<code class="highlighter-rouge">NIO(New IO)</code>, 就是采用了这种方式, 在套接字上提供<code class="highlighter-rouge">selector</code>选择机制, 当发起<code class="highlighter-rouge">select()</code>时会阻塞等待至少一个事件返回.</p>

<ul>
  <li>多路复用IO的特点是用户进程能同时等待多个IO请求, 系统来监控IO状态, 其中的任意一个进入读就绪状态, select函数就可以返回.</li>
</ul>

<h3 id="aio">AIO</h3>
<p><code class="highlighter-rouge">AIO</code>即<code class="highlighter-rouge">Asynchronous I/O</code>(异步 I/O), 这是<code class="highlighter-rouge">Java 1.7</code>引入的<code class="highlighter-rouge">NIO 2.0</code>中用到的. 整个过程中, 用户线程发起一个系统调用之后无须等待, 可以处理别的事情. 由操作系统等待接收内容, 接收后把数据拷贝到用户进程中, 最后通知用户程序已经可以使用数据了, 两个阶段都是非阻塞的. AIO整个过程如下图:</p>

<p><img src="/static/images/AIO.png" alt="AIO" title="AIO" /></p>

<p><code class="highlighter-rouge">AIO</code>属于异步模型, 用户线程可以同时处理别的事情, 我们怎么进一步加工处理结果呢? Java在这个模型中提供了两种方法:</p>

<ol>
  <li>一种是基于”回调”, 我们可以实现<code class="highlighter-rouge">CompletionHandler</code>接口, 在调用时把回调函数传递给对应的API即可</li>
  <li>另一种是返回一个<code class="highlighter-rouge">Future</code>. 处理完别的事情, 可以通过<code class="highlighter-rouge">isDone()</code>可查看是否已经准备好数据, 通过<code class="highlighter-rouge">get()</code>方法等待返回数据.</li>
</ol>

<h3 id="section-2">小结</h3>

<p>上面这几种模式, <code class="highlighter-rouge">BIO</code>整个过程都等待返回, <code class="highlighter-rouge">NIO</code>和<code class="highlighter-rouge">IO多路复用</code>在第二个阶段等待返回, 因此从整个过程来看, 这三个模式都属于同步方式. <code class="highlighter-rouge">AIO</code>在整个过程中没有等待返回, 属于异步方式.</p>

<hr />

        </div>
    </div>

    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <div class="ds-thread" data-thread-key="/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/十分钟了解BIO、NIO、AIO" data-title="十分钟了解BIO、NIO、AIO" data-url="/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-06-25-%E5%8D%81%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3BIO-NIO-AIO.html"></div>
    <!-- 多说评论框 end -->
</div>

    </div>

    <!-- 回到顶部 -->
    <div class="page-scrollTop" data-toggle="tooltip" data-placement="top" title="Top">
        <a href="javascript:void(0);">
            <div class="arrow"></div>
            <div class="stick"></div>
        </a>
    </div>

    <footer class="footer">
    <!-- 导航栏 -->
    <div class="uk-container uk-container-center">
        <div class="uk-container footwapper">
            <div class="uk-grid">
                <div class="uk-width-1-3 uk-text-center">
                    <span class="foot-text"> 京ICP备14015515号-1 </span>
                </div>
                <div class="uk-width-1-3 uk-text-center">
                    <span class="foot-text">
                        <a href="http://www.amazingcounters.com"><img border="0" src="http://cc.amazingcounters.com/counter.php?i=3195706&c=9587431" alt="AmazingCounters.com"></a>
                    </span>
                </div>
                <div class="uk-width-1-3 uk-text-center">
                <span class="foot-text"> <i class="uk-icon-copyright"></i>2015 Michael King. </span>
                </div>
                <div class="uk-hidden">
                    <span class="foot-text">
                        <!-- cnzz统计工具 -->
                        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254308303'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1254308303%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script>
                    </span>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- footer end -->


</body>

</html>
