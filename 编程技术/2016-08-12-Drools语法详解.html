<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Drools语法详解, 编程技术, Drools, 逆水行舟" />
  <meta name="description" content="Drools语法详解, 编程技术, Drools, 本文仅包含Drools的语法介绍, 不涉及如何使用,规则引擎介绍,算法介绍等方面."
  />

  <title>逆水行舟</title>

  <!-- ico图标 -->
  <link rel="shortcut icon" type="image/x-icon" media="screen" href="/static/favicon.ico" />
  <!-- 搜索引擎收入相关 -->
  <link rel="canonical" href="http://loveshisong.cn/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-08-12-Drools%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3.html" />
  <!-- rss输出源 -->
  <link rel="alternate" type="application/rss+xml" title="逆水行舟" href="http://loveshisong.cn/feed.xml" />
  <!-- jquery -->
  <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.11.3/jquery.js"></script>
  <!-- qrcode -->
  <!-- <script type="text/javascript" src="/static/js/jquery.qrcode.min.js"></script> -->
  <!-- UK core js -->
  <script type="text/javascript" src="/static/js/uikit.min.js"></script>
  <!-- UK sticky -->
  <script type="text/javascript" src="/static/js/components/sticky.min.js"></script>
  <!-- 本站js -->
  <script type="text/javascript" src="/static/js/script.js"></script>
  <!-- uk css-->
  <link rel="stylesheet" type="text/css" href="/static/css/uikit.min.css" />
  <!-- 基本样式 -->
  <link rel="stylesheet" type="text/css" href="/static/css/base.css" />
  <!-- 本站样式 -->
  <link rel="stylesheet" type="text/css" href="/static/css/main.css" />
  <!-- 代码高亮 -->
  <link rel="stylesheet" type="text/css" href="/static/css/highlight.css" />

  <!-- gitalk start (一个网页只需插入一次) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <!-- gitalk end -->
</head>


<body>

  <header class="header" data-uk-sticky>
  <!-- 导航栏 -->
  <div class="uk-container uk-container-center">
    <div class="headwapper">
      <div class="navbar uk-float-left">
        <a class="uk-navbar-brand uk-hidden-small" href="http://loveshisong.cn"> 逆水行舟 -- Michael King's Blog </a>
        <a class="uk-visible-small uk-icon-home uk-icon-large" href="http://loveshisong.cn"></a>
      </div>
      <div class="navbar uk-float-right">
        <ul class="navbar-nav">
          <li><a href="/pages/archive.html" title="归档" class="uk-icon-folder uk-icon-small"></a></li>
          <li><a href="/pages/categories.html" title="目录分类" class="uk-icon-list uk-icon-small"></a></li>
          <li><a href="/pages/tags.html" title="标签" class="uk-icon-tags uk-icon-small"></a></li>
          <li><a href="/pages/about.html" title="About Me" class="uk-icon-user uk-icon-small"></a></li>
          <li><a href="https://github.com/rgkjhshi" title="Github" class="uk-icon-github uk-icon-small"></a></li>
          <li><a href="/feed.xml" title="RSS" class="uk-icon-rss uk-icon-small"></a></li>
        </ul>
      </div>
    </div>
  </div>
</header>
<!-- header end -->


  <div class="uk-container uk-container-center">
    <!-- <script type="text/javascript">
jQuery(function(){
	jQuery('#qrcode').qrcode({
        width: 150,
        height: 150,
        text: "http://loveshisong.cn/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-08-12-Drools%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3.html"
    });
})
</script> -->
<!-- 日志默认模板 -->
<div class="uk-container content">
    <div class="page-title">
        <h1>Drools语法详解</h1>
    </div>
    <div class="uk-grid">
        <div  class="uk-width-4-4">
            <!-- <div id="qrcode" class="uk-float-right uk-thumbnail"></div> -->
            <p>本文仅包含<code class="highlighter-rouge">Drools</code>的语法介绍, 不涉及如何使用,规则引擎介绍,算法介绍等方面.</p>

<hr />

<ul id="markdown-toc">
  <li><a href="#语法全貌概览" id="markdown-toc-语法全貌概览">语法全貌概览</a>    <ul>
      <li><a href="#package" id="markdown-toc-package">package</a></li>
      <li><a href="#import" id="markdown-toc-import">import</a></li>
      <li><a href="#global" id="markdown-toc-global">global</a></li>
      <li><a href="#functon" id="markdown-toc-functon">functon</a></li>
    </ul>
  </li>
  <li><a href="#rule" id="markdown-toc-rule">rule</a></li>
  <li><a href="#规则属性" id="markdown-toc-规则属性">规则属性</a></li>
  <li><a href="#when" id="markdown-toc-when">when</a></li>
  <li><a href="#then" id="markdown-toc-then">then</a></li>
</ul>

<hr />

<h2 id="语法全貌概览">语法全貌概览</h2>

<p>规则文件一般都是<code class="highlighter-rouge">.drl</code>文件, 也可以是<code class="highlighter-rouge">xml</code>文件. 我们默认都是用<code class="highlighter-rouge">.drl</code>文件. 一个规则文件大致会有这样的结构:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">package</span>   <span class="cm">/* 包名, 必须, 逻辑上的管理, 不对应物理位置 */</span>
<span class="k">import</span>    <span class="cm">/* 导入类或方法, 与java中的import类似 */</span>
<span class="nb">global</span>    <span class="cm">/* 全局变量 */</span>
<span class="kd">function</span>  <span class="cm">/* 定义函数 */</span>
<span class="nx">query</span>     <span class="cm">/* 查询 */</span>
<span class="nx">rule</span>      <span class="cm">/* 规则, 可以由多个; 这是规则文件的主要部分 */</span>
</code></pre></div></div>

<p>来个具体的规则文件的例子:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">package</span> <span class="nx">com</span><span class="p">.</span><span class="nx">test</span><span class="p">.</span><span class="nx">drools</span><span class="p">;</span>

<span class="kd">function</span> <span class="k">void</span> <span class="nx">showName</span><span class="p">(</span><span class="nb">String</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">println</span><span class="p">(</span><span class="s2">"我是"</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">rule</span> <span class="s2">"rule1"</span>
    <span class="nx">when</span>
        <span class="kr">eval</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">then</span>
        <span class="nx">System</span><span class="p">.</span><span class="nx">out</span><span class="p">.</span><span class="nx">println</span><span class="p">(</span><span class="s2">"hello drools"</span><span class="p">);</span>
        <span class="nx">showName</span><span class="p">(</span><span class="s2">"test"</span><span class="p">);</span>
<span class="nx">end</span>
</code></pre></div></div>

<h3 id="package">package</h3>

<p><code class="highlighter-rouge">package</code>有以下几点</p>

<ul>
  <li><code class="highlighter-rouge">package</code>是必须的, 且必须放在规则文件第一行;</li>
  <li><code class="highlighter-rouge">package</code>的名字是随意的, 不必对应物理路径;</li>
  <li>跟<code class="highlighter-rouge">java</code>中<code class="highlighter-rouge">package</code>的概念不同,这里只是逻辑上的一种区分,同样的<code class="highlighter-rouge">package</code>下定义的<code class="highlighter-rouge">function</code>和<code class="highlighter-rouge">query</code>等可以直接使用。</li>
</ul>

<h3 id="import">import</h3>

<p><code class="highlighter-rouge">import</code>跟<code class="highlighter-rouge">java</code>中类似, 可以导入类, 也可以直接导入静态方法</p>

<h3 id="global">global</h3>

<p>定义全局变量,通常用于返回数据和提供服务; 全局变量与fact不通,引擎不能知道全局变量的改变,必须在插入fact之前,设置global变量</p>

<h3 id="functon">functon</h3>

<p>定义函数, 为了提高代码复用, 使用<code class="highlighter-rouge">java</code>语法书写</p>

<hr />

<h2 id="rule">rule</h2>

<p>定义一个规则, 格式大致为:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">rule</span> <span class="s2">"规则名"</span>
    <span class="o">&lt;</span><span class="err">属性</span><span class="o">&gt;&lt;</span><span class="err">值</span><span class="o">&gt;</span>
    <span class="nx">when</span>
        <span class="err">条件</span> <span class="p">(</span><span class="err">也叫</span> <span class="nx">Left</span> <span class="nx">Hand</span> <span class="nx">Side</span><span class="p">,</span> <span class="err">简称</span> <span class="nx">LHS</span><span class="p">)</span>
    <span class="nx">then</span>
        <span class="err">结果</span> <span class="p">(</span><span class="err">也叫</span> <span class="nx">Right</span> <span class="nx">Hand</span> <span class="nx">Side</span><span class="p">,</span> <span class="err">简称</span> <span class="nx">RHS</span><span class="p">)</span>
<span class="nx">end</span>
</code></pre></div></div>

<p>主要包含三部分:</p>

<ul>
  <li>属性部分: 定义当前规则执行的一些属性等,比如是否可被重复执行、过期时间、生效时间等</li>
  <li>条件部分: 即<code class="highlighter-rouge">LHS</code>, 定义当前规则的条件; 如 <code class="highlighter-rouge">when Message();</code> 判断当前<code class="highlighter-rouge">workingMemory</code>中是否存在<code class="highlighter-rouge">Message</code>对象</li>
  <li>结果部分: 即<code class="highlighter-rouge">RHS</code>, 即当前规则条件满足后执行的操作,可以直接调用<code class="highlighter-rouge">Fact</code>对象的方法来操作应用,可写java代码</li>
</ul>

<hr />

<h2 id="规则属性">规则属性</h2>
<p>属性有这些内容: <code class="highlighter-rouge">activation-group</code>, <code class="highlighter-rouge">agenda-group</code>, <code class="highlighter-rouge">auto-focus</code>, <code class="highlighter-rouge">date-effective</code>, <code class="highlighter-rouge">date-expires</code>, <code class="highlighter-rouge">dialect</code>, <code class="highlighter-rouge">duration</code>, <code class="highlighter-rouge">duration-value</code>, <code class="highlighter-rouge">enabled</code>, <code class="highlighter-rouge">lock-on-active</code>, <code class="highlighter-rouge">no-loop</code>, <code class="highlighter-rouge">ruleflow-group</code>, <code class="highlighter-rouge">salience</code></p>

<p>下面挨个解释:</p>

<ul>
  <li><code class="highlighter-rouge">salience</code>: 优先级, 属性值是一个数字, 数值越大越先执行, 可以是负数, 默认为<code class="highlighter-rouge">0</code>. 这个可以控制规则的执行顺序</li>
  <li><code class="highlighter-rouge">date-effective</code>: 设置规则的生效时间, <code class="highlighter-rouge">当前系统时间&gt;=date-effective</code>时才会触发执行, 值是一个日期格式的字符串, 推荐用法是手动在java代码中设置当前系统的时间格式, 然后按照格式指定时间. 比如: <code class="highlighter-rouge">date-expires "2016-01-31 23:59:59"</code></li>
  <li><code class="highlighter-rouge">date-expires</code>: 设置规则的过期时间, 跟上面正好相反.</li>
  <li><code class="highlighter-rouge">enabled</code>: 表示该规则是否可用, 值为布尔类型, 默认是<code class="highlighter-rouge">true</code>, 设置成<code class="highlighter-rouge">false</code>则该规则就不会被执行了</li>
  <li><code class="highlighter-rouge">dialect</code>: 设置语言类型, 值为字符串, 一般有两种语言,<code class="highlighter-rouge">mvel</code>和<code class="highlighter-rouge">java</code>, 默认为<code class="highlighter-rouge">java</code></li>
  <li><code class="highlighter-rouge">duration</code>: 规则定时, 值为长整型, 单位为毫秒, 如 <code class="highlighter-rouge">duration 3000</code>, 表示规则在3秒后执行(另外的线程中执行)</li>
  <li><code class="highlighter-rouge">no-loop</code>: 是否允许规则多次执行, 值为布尔类型, 默认是<code class="highlighter-rouge">false</code>, 即当前的规则只要满足条件, 可以无限次执行; 对当前传入<code class="highlighter-rouge">workingMemory</code>中的<code class="highlighter-rouge">Fact</code>对象进行修改或者个数的增减时, 就会触发规则重新匹配执行; 设置属性<code class="highlighter-rouge">no-loop true</code>, 表示当前规则只执行一次, 即使<code class="highlighter-rouge">RHS</code>中更新了当前<code class="highlighter-rouge">Fact</code>对象也不会再次执行该规则了. 不过当其他规则里更新了<code class="highlighter-rouge">Fact</code>对象时, 即使有<code class="highlighter-rouge">no-loop true</code>也会触发, 即<code class="highlighter-rouge">no-loop true</code>仅表示本规的<code class="highlighter-rouge">RHS</code>中有更新时不重复执行.</li>
  <li><code class="highlighter-rouge">lock-on-active</code>: 是<code class="highlighter-rouge">no-loop</code>的增强版, 与其他属性配合使用;规则的重复执行不一定是本身触发的, 也可能是其他规则触发的, 当在规则上使用<code class="highlighter-rouge">ruleflow-group</code>属性或<code class="highlighter-rouge">agenda-group</code>属性时, 将<code class="highlighter-rouge">lock-on-active</code>属性值设置为<code class="highlighter-rouge">true</code>，可避免因某些<code class="highlighter-rouge">Fact</code>对象被修改而使已经执行过的规则再次被激活执行.</li>
  <li><code class="highlighter-rouge">activation-group</code>: 作用是将规则分组, 值为字符串表示组名,这样在执行的时候,具有相同<code class="highlighter-rouge">activation-group</code>属性的规则中只要有一个会被执行,其它的规则都将不再执行。即在具有相同<code class="highlighter-rouge">activation-group</code>属性的规则当中,只有一个规则会被执行,其它规则都将不会被执行.相同<code class="highlighter-rouge">activation-group</code>属性的规则中哪一个会先执行,则可以用<code class="highlighter-rouge">salience</code>之类的属性来实现</li>
  <li>
    <p><code class="highlighter-rouge">agenda-group</code>: 将规则分成若干个<code class="highlighter-rouge">Agenda Group</code>, 默认情况下, 引擎在调用这些设置了<code class="highlighter-rouge">agenda-group</code>属性的规则时需要显示的指定某个<code class="highlighter-rouge">Agenda Group</code>得到<code class="highlighter-rouge">Focus(焦点)</code>,这样位于该<code class="highlighter-rouge">Agenda Group</code>中的规则才会触发执行,否则将不执行</p>
  </li>
  <li><code class="highlighter-rouge">ruleflow-group</code>: 使用规则流的时候会用到该属性, 作用是将规则分组，然后在规则流当中通过使用<code class="highlighter-rouge">ruleflow-group</code>属性的值，从而使用对应的规则</li>
</ul>

<hr />

<h2 id="when">when</h2>
<p>条件部分(Conditions/LHS)用于匹配条件, 也叫匹配模式(Pattern)</p>

<p>条件可以是单个, 也可以有多个, 下面是一些例子</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">when</span>
    <span class="kr">eval</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>            <span class="c1">// 是一个默认的api, 类似于 while(true)</span>
    <span class="nx">Person</span><span class="p">()</span>              <span class="c1">// 当前的 workingMemory 中存在 Pserson 类型的 Fact 对象</span>
    <span class="nx">$person</span><span class="p">:</span><span class="nx">Person</span><span class="p">()</span>      <span class="c1">// 同上, $person 是给对象起的名字</span>
    <span class="nx">$bob</span><span class="p">:</span><span class="nx">Person</span><span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">"bob"</span><span class="p">)</span>  <span class="c1">// 字段绑定, 存在 Person 类型且属性 name 值为bob的对象</span>
    <span class="nx">Person</span><span class="p">(</span><span class="nx">$name</span><span class="p">:</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">"bob"</span><span class="p">)</span> <span class="c1">// 与上面类似, 只是把名字放到了 $name 变量里</span>
    <span class="nx">Person</span><span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">$name</span><span class="p">)</span> <span class="c1">// 与上面类似, 只是把名字放到了 $name 变量里</span>
    <span class="nx">$tom</span><span class="p">:</span><span class="nx">Person</span><span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">"tom"</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s2">"Tom"</span><span class="p">)</span> <span class="c1">// 条件组合</span>
<span class="nx">then</span>
    <span class="p">...</span>  <span class="c1">// 上面起的变量这里可以直接使用</span>
</code></pre></div></div>

<p>注意:</p>

<ul>
  <li>上例中的<code class="highlighter-rouge">$person</code>, <code class="highlighter-rouge">$bob</code>等代表着符合条件的变量的引用, 在后面的条件部分和<code class="highlighter-rouge">RHS</code>部分中可直接使用</li>
  <li>条件可以有组合, 如<code class="highlighter-rouge">Person(age == 18 &amp;&amp; (name == "tom" || name == "Tom"))</code>, 若条件全是<code class="highlighter-rouge">&amp;&amp;</code>关系, 可以使用<code class="highlighter-rouge">,</code>代替, 但两者不能混用.</li>
  <li><code class="highlighter-rouge">Fact</code>对象(即输入的数据,类似于java bean)的private属性, 在<code class="highlighter-rouge">LHS</code>中必须用<code class="highlighter-rouge">.</code>引用, 如<code class="highlighter-rouge">($person.name == "tom")</code>, 而<code class="highlighter-rouge">RHS</code>中必须使用 <code class="highlighter-rouge">getter</code> 和 <code class="highlighter-rouge">setter</code> 方法</li>
</ul>

<p>另外<code class="highlighter-rouge">drools</code>提供了十二种比较操作符, 有:<code class="highlighter-rouge">&gt;</code>, <code class="highlighter-rouge">&gt;=</code>, <code class="highlighter-rouge">&lt;</code>, <code class="highlighter-rouge">&lt;=</code>, <code class="highlighter-rouge">==</code>, <code class="highlighter-rouge">!=</code>, <code class="highlighter-rouge">contains</code>, <code class="highlighter-rouge">not contains</code>, <code class="highlighter-rouge">memberOf</code>, <code class="highlighter-rouge">not memberOf</code>, <code class="highlighter-rouge">matches</code>, <code class="highlighter-rouge">not matches</code></p>

<ul>
  <li><code class="highlighter-rouge">contains</code>: 是否包含, 被比较对象可以是一个复杂对象也可以是一个简单的值</li>
  <li><code class="highlighter-rouge">memberOf</code>: 是否在某个集合中, 与<code class="highlighter-rouge">contains</code>不同的是他被比较的对象是一个集合, 而<code class="highlighter-rouge">contains</code>被比较的对象是单个值或者对象</li>
  <li><code class="highlighter-rouge">matches</code>: 正则表达式匹配</li>
</ul>

<hr />

<h2 id="then">then</h2>
<p>RHS, 这部分是普通的<code class="highlighter-rouge">java</code>代码, 记得加<code class="highlighter-rouge">;</code>.<br />
另外<code class="highlighter-rouge">drools</code>提供了几个方法:</p>

<ul>
  <li><code class="highlighter-rouge">insert</code>: 往当前<code class="highlighter-rouge">workingMemory</code>中插入一个新的<code class="highlighter-rouge">Fact</code>对象, 会触发规则的再次执行,除非使用no-loop限定</li>
  <li><code class="highlighter-rouge">update</code>: 更新</li>
  <li><code class="highlighter-rouge">modify</code>: 修改, 与<code class="highlighter-rouge">update</code>语法不同, 效果一样, 结果都是更新操作</li>
  <li><code class="highlighter-rouge">retract</code>: 删除</li>
</ul>

<hr />

        </div>
    </div>

    <!-- gitalk评论框 start (一个网页只需插入一次) -->
    <!-- <div id="gitalk-container">
        <script type="text/javascript">
            var gitalk = new Gitalk({
                // gitalk的主要参数
                clientID: `9dc0d8d7df27d927c04e`,
                clientSecret: `48882a3ff7b351d89e7e67b4c61c7301d64afca2`,
                repo: `rgkjhshi.github.io`,
                owner: 'rgkjhshi',
                admin: ['rgkjhshi'],
                id: 'Drools语法详解',
            });
            gitalk.render('gitalk-container');
        </script>
    </div> -->
    <!-- gitalk评论框 end -->
</div>

  </div>

  <!-- 回到顶部 -->
  <div class="page-scrollTop" data-toggle="tooltip" data-placement="top" title="Top">
    <a href="javascript:void(0);">
      <div class="arrow"></div>
      <div class="stick"></div>
    </a>
  </div>

  <footer class="footer">
    <!-- 导航栏 -->
    <div class="uk-container uk-container-center">
        <div class="uk-container footwapper">
            <div class="uk-grid">
                <div class="uk-width-1-3 uk-text-center">
                    <span class="foot-text"> 京ICP备14015515号-1 </span>
                </div>
                <div class="uk-width-1-3 uk-text-center">
                    <span class="foot-text">
                        <a href="http://www.amazingcounters.com"><img border="0" src="http://cc.amazingcounters.com/counter.php?i=3195706&c=9587431" alt="AmazingCounters.com"></a>
                    </span>
                </div>
                <div class="uk-width-1-3 uk-text-center">
                <span class="foot-text"> <i class="uk-icon-copyright"></i>2015 Michael King. </span>
                </div>
                <div class="uk-hidden">
                    <span class="foot-text">
                        <!-- cnzz统计工具 -->
                        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254308303'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1254308303%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script>
                    </span>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- footer end -->


</body>

</html>
