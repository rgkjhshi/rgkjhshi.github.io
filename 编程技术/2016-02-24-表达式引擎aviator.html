<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="表达式引擎aviator, 编程技术, Java, 逆水行舟" />
  <meta name="description" content="表达式引擎aviator, 编程技术, Java, Aviator是一个轻量级、高性能的Java表达式执行引擎, 本文内容主要来自于官方文档"
  />

  <title>逆水行舟</title>

  <!-- ico图标 -->
  <link rel="shortcut icon" type="image/x-icon" media="screen" href="/static/favicon.ico" />
  <!-- 搜索引擎收入相关 -->
  <link rel="canonical" href="http://loveshisong.cn/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-02-24-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%BC%95%E6%93%8Eaviator.html" />
  <!-- rss输出源 -->
  <link rel="alternate" type="application/rss+xml" title="逆水行舟" href="http://loveshisong.cn/feed.xml" />
  <!-- jquery -->
  <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.11.3/jquery.js"></script>
  <!-- qrcode -->
  <!-- <script type="text/javascript" src="/static/js/jquery.qrcode.min.js"></script> -->
  <!-- UK core js -->
  <script type="text/javascript" src="/static/js/uikit.min.js"></script>
  <!-- UK sticky -->
  <script type="text/javascript" src="/static/js/components/sticky.min.js"></script>
  <!-- 本站js -->
  <script type="text/javascript" src="/static/js/script.js"></script>
  <!-- uk css-->
  <link rel="stylesheet" type="text/css" href="/static/css/uikit.min.css" />
  <!-- 基本样式 -->
  <link rel="stylesheet" type="text/css" href="/static/css/base.css" />
  <!-- 本站样式 -->
  <link rel="stylesheet" type="text/css" href="/static/css/main.css" />
  <!-- 代码高亮 -->
  <link rel="stylesheet" type="text/css" href="/static/css/highlight.css" />
  <!-- gitalk start (一个网页只需插入一次) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <!-- gitalk end -->
</head>


<body>

  <header class="header" data-uk-sticky>
  <!-- 导航栏 -->
  <div class="uk-container uk-container-center">
    <div class="headwapper">
      <div class="navbar uk-float-left">
        <a class="uk-navbar-brand uk-hidden-small" href="http://loveshisong.cn"> 逆水行舟 -- Michael King's Blog </a>
        <a class="uk-visible-small uk-icon-home uk-icon-large" href="http://loveshisong.cn"></a>
      </div>
      <div class="navbar uk-float-right">
        <ul class="navbar-nav">
          <li><a href="/pages/archive.html" title="归档" class="uk-icon-folder uk-icon-small"></a></li>
          <li><a href="/pages/categories.html" title="目录分类" class="uk-icon-list uk-icon-small"></a></li>
          <li><a href="/pages/tags.html" title="标签" class="uk-icon-tags uk-icon-small"></a></li>
          <li><a href="/pages/about.html" title="About Me" class="uk-icon-user uk-icon-small"></a></li>
          <li><a href="https://github.com/rgkjhshi" title="Github" class="uk-icon-github uk-icon-small"></a></li>
          <li><a href="/feed.xml" title="RSS" class="uk-icon-rss uk-icon-small"></a></li>
        </ul>
      </div>
    </div>
  </div>
</header>
<!-- header end -->


  <div class="uk-container uk-container-center">
    <!-- <script type="text/javascript">
jQuery(function(){
	jQuery('#qrcode').qrcode({
        width: 150,
        height: 150,
        text: "http://loveshisong.cn/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/2016-02-24-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%BC%95%E6%93%8Eaviator.html"
    });
})
</script> -->
<!-- 日志默认模板 -->
<div class="uk-container content">
    <div class="page-title">
        <h1>表达式引擎aviator</h1>
    </div>
    <div class="uk-grid">
        <div  class="uk-width-4-4">
            <!-- <div id="qrcode" class="uk-float-right uk-thumbnail"></div> -->
            <p>Aviator是一个轻量级、高性能的Java表达式执行引擎, 本文内容主要来自于官方文档</p>

<hr />

<ul id="markdown-toc">
  <li><a href="#简介" id="markdown-toc-简介">简介</a></li>
  <li><a href="#包依赖" id="markdown-toc-包依赖">包依赖</a></li>
  <li><a href="#使用手册" id="markdown-toc-使用手册">使用手册</a>    <ul>
      <li><a href="#执行表达式" id="markdown-toc-执行表达式">执行表达式</a></li>
      <li><a href="#使用变量" id="markdown-toc-使用变量">使用变量</a></li>
      <li><a href="#exec-方法" id="markdown-toc-exec-方法">exec 方法</a></li>
      <li><a href="#调用函数" id="markdown-toc-调用函数">调用函数</a></li>
      <li><a href="#自定义函数" id="markdown-toc-自定义函数">自定义函数</a></li>
      <li><a href="#编译表达式" id="markdown-toc-编译表达式">编译表达式</a></li>
      <li><a href="#访问数组和集合" id="markdown-toc-访问数组和集合">访问数组和集合</a></li>
      <li><a href="#三元操作符" id="markdown-toc-三元操作符">三元操作符</a></li>
      <li><a href="#正则表达式匹配" id="markdown-toc-正则表达式匹配">正则表达式匹配</a></li>
      <li><a href="#变量的语法糖" id="markdown-toc-变量的语法糖">变量的语法糖</a></li>
      <li><a href="#nil-对象" id="markdown-toc-nil-对象">nil 对象</a></li>
      <li><a href="#日期比较" id="markdown-toc-日期比较">日期比较</a></li>
      <li><a href="#大数计算和精度" id="markdown-toc-大数计算和精度">大数计算和精度</a>        <ul>
          <li><a href="#字面量表示" id="markdown-toc-字面量表示">字面量表示</a></li>
          <li><a href="#运算" id="markdown-toc-运算">运算</a></li>
          <li><a href="#类型转换和提升" id="markdown-toc-类型转换和提升">类型转换和提升</a></li>
          <li><a href="#decimal-的计算精度" id="markdown-toc-decimal-的计算精度">decimal 的计算精度</a></li>
        </ul>
      </li>
      <li><a href="#强大的-seq-库" id="markdown-toc-强大的-seq-库">强大的 seq 库</a></li>
      <li><a href="#两种运行模式" id="markdown-toc-两种运行模式">两种运行模式</a></li>
      <li><a href="#调试信息" id="markdown-toc-调试信息">调试信息</a></li>
    </ul>
  </li>
  <li><a href="#语法手册" id="markdown-toc-语法手册">语法手册</a>    <ul>
      <li><a href="#数据类型" id="markdown-toc-数据类型">数据类型</a></li>
      <li><a href="#操作符" id="markdown-toc-操作符">操作符</a>        <ul>
          <li><a href="#算术运算符" id="markdown-toc-算术运算符">算术运算符</a></li>
          <li><a href="#逻辑运算符" id="markdown-toc-逻辑运算符">逻辑运算符</a></li>
          <li><a href="#关系运算符" id="markdown-toc-关系运算符">关系运算符</a></li>
          <li><a href="#位运算符" id="markdown-toc-位运算符">位运算符</a></li>
          <li><a href="#匹配运算符" id="markdown-toc-匹配运算符">匹配运算符</a></li>
          <li><a href="#三元运算符" id="markdown-toc-三元运算符">三元运算符</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#内置函数" id="markdown-toc-内置函数">内置函数</a></li>
  <li><a href="#相关链接" id="markdown-toc-相关链接">相关链接</a></li>
</ul>

<hr />

<h2 id="简介">简介</h2>

<p>Aviator是一个高性能、轻量级的 java 语言实现的表达式求值引擎, 主要用于各种表达式的动态求值。现在已经有很多开源可用的 java 表达式求值引擎,为什么还需要 Avaitor 呢?<br />
Aviator的设计目标是轻量级和高性能,相比于Groovy、JRuby的笨重, Aviator非常小, 加上依赖包也才450K,不算依赖包的话只有 70K; 当然, Aviator的语法是受限的, 它不是一门完整的语言, 而只是语言的一小部分集合。<br />
其次, Aviator的实现思路与其他轻量级的求值器很不相同, 其他求值器一般都是通过解释的方式运行, 而Aviator则是直接将表达式编译成Java 字节码, 交给JVM去执行。简单来说, Aviator的定位是介于Groovy这样的重量级脚本语言和IKExpression这样的轻量级表达式引擎 之间。<br />
Aviator支持大部分运算操作符, 包括算术操作符、关系运算符、逻辑操作符、位运算符、正则匹配操作符(<code class="highlighter-rouge">=~</code>)、三元表达式(<code class="highlighter-rouge">?:</code>), 并且支持操作符的优先级和括号强制优先级, 具体请看后面的操作符列表, 支持自定义函数.</p>

<h2 id="包依赖">包依赖</h2>

<p>Aviator依赖了<code class="highlighter-rouge">commons-beanutils</code>, 使用Aviator可以添加下面的maven依赖:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.googlecode.aviator<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>aviator<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.3.3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h2 id="使用手册">使用手册</h2>

<h3 id="执行表达式">执行表达式</h3>

<p>Aviator的使用都是集中通过<code class="highlighter-rouge">com.googlecode.aviator.AviatorEvaluator</code>这个入口类来处理, 最简单的例子, 执行一个计算<code class="highlighter-rouge">1+2+3</code>的表达式:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.googlecode.aviator.AviatorEvaluator</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAviator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Long</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"1+2+3"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>细心的朋友肯定注意到结果是<code class="highlighter-rouge">Long</code>,而不是<code class="highlighter-rouge">Integer</code>。这是因为<code class="highlighter-rouge">Aviator</code>的数值类型仅支持<code class="highlighter-rouge">Long</code>和<code class="highlighter-rouge">Double</code>, 任何整数都将转换成<code class="highlighter-rouge">Long</code>, 任何浮点数都将转换为<code class="highlighter-rouge">Double</code>, 包括用户传入的变量数值。这个例子的打印结果将是正确答案<code class="highlighter-rouge">6</code>。</p>

<h3 id="使用变量">使用变量</h3>

<p>想让Aviator对你<code class="highlighter-rouge">say hello</code>吗? 很简单, 传入你的名字, 让Aviator负责字符串的相加:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAviator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">yourName</span> <span class="o">=</span> <span class="s">"Michael"</span><span class="o">;</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"yourName"</span><span class="o">,</span> <span class="n">yourName</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" 'hello ' + yourName "</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// hello Michael</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>上面的例子演示了怎么向表达式传入变量值, 表达式中的<code class="highlighter-rouge">yourName</code>是一个变量, 默认为<code class="highlighter-rouge">null</code>, 通过传入<code class="highlighter-rouge">Map&lt;String,Object&gt;</code>的变量绑定环境, 将<code class="highlighter-rouge">yourName</code>设置为你输入的名称。 <code class="highlighter-rouge">env</code>
的<code class="highlighter-rouge">key</code>是变量名, <code class="highlighter-rouge">value</code>是变量的值。<br />
上面例子中的<code class="highlighter-rouge">'hello '</code>是一个<code class="highlighter-rouge">Aviator</code>的<code class="highlighter-rouge">String</code>, <code class="highlighter-rouge">Aviator</code>的<code class="highlighter-rouge">String</code>是任何用单引号或者双引号括起来的字符序列, <code class="highlighter-rouge">String</code>可以比较大小(基于<code class="highlighter-rouge">unicode</code>顺序), 可以参与正则匹配, 可以与任何对象相加, 任何对象与<code class="highlighter-rouge">String</code>相加结果为<code class="highlighter-rouge">String</code>。 <code class="highlighter-rouge">String</code>中也可以有转义字符,如<code class="highlighter-rouge">\n、\\、\'</code> 等。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" 'a\"b' "</span><span class="o">);</span>           <span class="c1">// 字符串 a"b</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" \"a\'b\" "</span><span class="o">);</span>         <span class="c1">// 字符串 a'b</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" 'hello ' + 3 "</span><span class="o">);</span>     <span class="c1">// 字符串 hello 3</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" 'hello '+ unknow "</span><span class="o">);</span> <span class="c1">// 字符串 hello null</span>
</code></pre></div></div>

<h3 id="exec-方法">exec 方法</h3>

<p>Aviator 2.2 开始新增加一个<code class="highlighter-rouge">exec</code>方法, 可以更方便地传入变量并执行, 而不需要构造<code class="highlighter-rouge">env</code>这个<code class="highlighter-rouge">map</code>了:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"dennis"</span><span class="o">;</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">" 'hello ' + yourName "</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span> <span class="c1">// hello dennis</span>
</code></pre></div></div>

<p>只要在<code class="highlighter-rouge">exec</code>中按照变量在表达式中的出现顺序传入变量值就可以执行, 不需要构建<code class="highlighter-rouge">Map</code>了。</p>

<h3 id="调用函数">调用函数</h3>

<p>Aviator 支持函数调用, 函数调用的风格类似 lua, 下面的例子获取字符串的长度:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"string.length('hello')"</span><span class="o">);</span>  <span class="c1">// 5</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">string.length('hello')</code>是一个函数调用, <code class="highlighter-rouge">string.length</code>是一个函数, <code class="highlighter-rouge">'hello'</code>是调用的参数。<br />
再用<code class="highlighter-rouge">string.substring</code>来截取字符串:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"string.contains(\"test\", string.substring('hello', 1, 2))"</span><span class="o">);</span>  <span class="c1">// true</span>
</code></pre></div></div>

<p>通过<code class="highlighter-rouge">string.substring('hello', 1, 2)</code>获取字符串<code class="highlighter-rouge">'e'</code>, 然后通过函数<code class="highlighter-rouge">string.contains</code>判断<code class="highlighter-rouge">e</code>是否在<code class="highlighter-rouge">'test'</code>中。可以看到, 函数可以嵌套调用。<br />
Aviator 的内置函数列表请看后面。</p>

<h3 id="自定义函数">自定义函数</h3>

<p>Aviator 除了内置的函数之外,还允许用户自定义函数,只要实现<code class="highlighter-rouge">com.googlecode.aviator.runtime.type.AviatorFunction</code>接口, 并注册到<code class="highlighter-rouge">AviatorEvaluator</code>即可使用. <code class="highlighter-rouge">AviatorFunction</code>接口十分庞大, 通常来说你并不需要实现所有的方法, 只要根据你的方法的参 数个数, 继承<code class="highlighter-rouge">AbstractFunction</code>类并<code class="highlighter-rouge">override</code>相应方法即可。</p>

<p>可以看一个例子,我们实现一个<code class="highlighter-rouge">add</code>函数来做数值的相加:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAviator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//注册函数</span>
        <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">addFunction</span><span class="o">(</span><span class="k">new</span> <span class="n">AddFunction</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"add(1, 2)"</span><span class="o">));</span>           <span class="c1">// 3.0</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"add(add(1, 2), 100)"</span><span class="o">));</span> <span class="c1">// 103.0</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">AddFunction</span> <span class="kd">extends</span> <span class="n">AbstractFunction</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">AviatorObject</span> <span class="nf">call</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span><span class="o">,</span> <span class="n">AviatorObject</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">AviatorObject</span> <span class="n">arg2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Number</span> <span class="n">left</span> <span class="o">=</span> <span class="n">FunctionUtils</span><span class="o">.</span><span class="na">getNumberValue</span><span class="o">(</span><span class="n">arg1</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
        <span class="n">Number</span> <span class="n">right</span> <span class="o">=</span> <span class="n">FunctionUtils</span><span class="o">.</span><span class="na">getNumberValue</span><span class="o">(</span><span class="n">arg2</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AviatorDouble</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">()</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"add"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>注册函数通过<code class="highlighter-rouge">AviatorEvaluator.addFunction</code>方法, 移除可以通过<code class="highlighter-rouge">removeFunction</code>。</p>

<h3 id="编译表达式">编译表达式</h3>

<p>上面提到的例子都是直接执行表达式, 事实上 Aviator 背后都帮你做了编译并执行的工作。 你可以自己先编译表达式, 返回一个编译的结果, 然后传入不同的<code class="highlighter-rouge">env</code>来复用编译结果, 提高性能, 这是更推荐的使用方式:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAviator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">expression</span> <span class="o">=</span> <span class="s">"a-(b-c)&gt;100"</span><span class="o">;</span>
        <span class="c1">// 编译表达式</span>
        <span class="n">Expression</span> <span class="n">compiledExp</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">expression</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mf">100.3</span><span class="o">);</span>
        <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"b"</span><span class="o">,</span> <span class="mi">45</span><span class="o">);</span>
        <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"c"</span><span class="o">,</span> <span class="o">-</span><span class="mf">199.100</span><span class="o">);</span>
        <span class="c1">// 执行表达式</span>
        <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">compiledExp</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// false</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>通过<code class="highlighter-rouge">compile</code>方法可以将表达式编译成<code class="highlighter-rouge">Expression</code>的中间对象, 当要执行表达式的时候传入<code class="highlighter-rouge">env</code>并调用<code class="highlighter-rouge">Expression</code>的<code class="highlighter-rouge">execute</code>方法即可。 表达式中使用了括号来强制优先级, 这个例子还使用了<code class="highlighter-rouge">&gt;</code>用于比较数值大小, 比较运算符<code class="highlighter-rouge">!=、==、&gt;、&gt;=、&lt;、&lt;=</code>不仅可以用于数值, 也可以用于<code class="highlighter-rouge">String、Pattern、Boolean</code>等等, 甚至是任何用户传入的两个都实现了<code class="highlighter-rouge">java.lang.Comparable</code>接口的对象之间。</p>

<p>编译后的结果你可以自己缓存, 也可以交给 Aviator 帮你缓存, <code class="highlighter-rouge">AviatorEvaluator</code>内部有一个全局的缓存池, 如果你决定缓存编译结果, 可以通过:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="n">Expression</span> <span class="nf">compile</span><span class="o">(</span><span class="n">String</span> <span class="n">expression</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">cached</span><span class="o">)</span>
</code></pre></div></div>

<p>将<code class="highlighter-rouge">cached</code>设置为<code class="highlighter-rouge">true</code>即可, 那么下次编译同一个表达式的时候将直接返回上一次编译的结果。<br />
使缓存失效通过:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invalidateCache</span><span class="o">(</span><span class="n">String</span> <span class="n">expression</span><span class="o">)</span>
</code></pre></div></div>

<p>方法。</p>

<h3 id="访问数组和集合">访问数组和集合</h3>

<p>可以通过中括号去访问数组和<code class="highlighter-rouge">java.util.List</code>对象, 可以通过<code class="highlighter-rouge">map.key</code>访问<code class="highlighter-rouge">java.util.Map</code>中<code class="highlighter-rouge">key</code>对应的<code class="highlighter-rouge">value</code>, 一个例子:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">" world"</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">3</span><span class="o">];</span>
    <span class="n">array</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">array</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="n">array</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Date</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Date</span><span class="o">&gt;();</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"date"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"list"</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"array"</span><span class="o">,</span> <span class="n">array</span><span class="o">);</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mmap"</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"list[0]+list[1]"</span><span class="o">,</span> <span class="n">env</span><span class="o">));</span>   <span class="c1">// hello world</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"'array[0]+array[1]+array[2]=' + (array[0]+array[1]+array[2])"</span><span class="o">,</span> <span class="n">env</span><span class="o">));</span>  <span class="c1">// array[0]+array[1]+array[2]=4</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"'today is ' + mmap.date "</span><span class="o">,</span> <span class="n">env</span><span class="o">));</span>  <span class="c1">// today is Wed Feb 24 17:31:45 CST 2016</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="三元操作符">三元操作符</h3>

<p>Aviator 不提供<code class="highlighter-rouge">if else</code>语句, 但是提供了三元操作符<code class="highlighter-rouge">?:</code>用于条件判断,使用上与 java 没有什么不同:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"a&gt;0? 'yes':'no'"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>  <span class="c1">// yes</span>
</code></pre></div></div>

<p>Aviator 的三元表达式对于两个分支的结果类型并不要求一致,可以是任何类型,这一点与 java 不同。</p>

<h3 id="正则表达式匹配">正则表达式匹配</h3>

<p>Aviator 支持类 Ruby 和 Perl 风格的表达式匹配运算,通过<code class="highlighter-rouge">=~</code>操作符, 如下面这个例子匹配 email 并提取用户名返回:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">email</span> <span class="o">=</span> <span class="s">"killme2008@gmail.com"</span><span class="o">;</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"email"</span><span class="o">,</span> <span class="n">email</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"email=~/([\\w0-8]+)@\\w+[\\.\\w+]+/ ? $1 : 'unknow' "</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">username</span><span class="o">);</span> <span class="c1">// killme2008</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">email</code>与正则表达式<code class="highlighter-rouge">/([\\w0-8]+@\\w+[\\.\\w+]+)/</code>通过<code class="highlighter-rouge">=~</code>操作符来匹配,结果为一个 <code class="highlighter-rouge">Boolean</code> 类 型, 因此可以用于三元表达式判断,匹配成功的时候返回<code class="highlighter-rouge">$1</code>,指代正则表达式的分组 1,也就是用户名,否则返回<code class="highlighter-rouge">unknown</code>。</p>

<p>Aviator 在表达式级别支持正则表达式,通过<code class="highlighter-rouge">//</code>括起来的字符序列构成一个正则表达式,正则表 达式可以用于匹配(作为<code class="highlighter-rouge">=~</code>的右操作数)、比较大小,匹配仅能与字符串进行匹配。匹配成功后, Aviator 会自动将匹配成功的分组放入<code class="highlighter-rouge">$num</code>的变量中,其中<code class="highlighter-rouge">$0</code> 指代整个匹配的字符串,而<code class="highlighter-rouge">$1</code>表示第一个分组,以此类推。</p>

<p>Aviator 的正则表达式规则跟 Java 完全一样,因为内部其实就是使用<code class="highlighter-rouge">java.util.regex.Pattern</code>做编译的。</p>

<h3 id="变量的语法糖">变量的语法糖</h3>

<p>Aviator 有个方便用户使用变量的语法糖, 当你要访问变量<code class="highlighter-rouge">a</code>中的某个属性<code class="highlighter-rouge">b</code>, 那么你可以通过<code class="highlighter-rouge">a.b</code>访问到, 更进一步, <code class="highlighter-rouge">a.b.c</code>将访问变量<code class="highlighter-rouge">a</code>的<code class="highlighter-rouge">b</code>属性中的<code class="highlighter-rouge">c</code>属性值, 推广开来也就是说 Aviator 可以将变量声明为嵌套访问的形式。<br />
<code class="highlighter-rouge">TestAviator</code>类符合<code class="highlighter-rouge">JavaBean</code>规范, 并且是 <code class="highlighter-rouge">public</code> 的，我们就可以使用语法糖:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAviator</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>
    <span class="kt">float</span> <span class="n">f</span><span class="o">;</span>
    <span class="n">Date</span> <span class="n">date</span><span class="o">;</span>
    <span class="c1">// 构造方法</span>
    <span class="kd">public</span> <span class="nf">TestAviator</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">float</span> <span class="n">f</span><span class="o">,</span> <span class="n">Date</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// getter and setter</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">TestAviator</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestAviator</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mf">3.14f</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="n">foo</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"'foo.i = '+foo.i"</span><span class="o">,</span> <span class="n">env</span><span class="o">));</span>   <span class="c1">// foo.i = 100</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"'foo.f = '+foo.f"</span><span class="o">,</span> <span class="n">env</span><span class="o">));</span>   <span class="c1">// foo.f = 3.14</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"'foo.date.year = '+(foo.date.year+1990)"</span><span class="o">,</span> <span class="n">env</span><span class="o">));</span>  <span class="c1">// foo.date.year = 2106</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="nil-对象">nil 对象</h3>

<p><code class="highlighter-rouge">nil</code>是 Aviator 内置的常量,类似 java 中的<code class="highlighter-rouge">null</code>,表示空的值。<code class="highlighter-rouge">nil</code>跟<code class="highlighter-rouge">null</code>不同的在于,在 java 中<code class="highlighter-rouge">null</code>只能使用在<code class="highlighter-rouge">==、!=</code>的比较运算符,而<code class="highlighter-rouge">nil</code>还可以使用<code class="highlighter-rouge">&gt;、&gt;=、&lt;、&lt;=</code>等比较运算符。 Aviator 规定,任何对象都比<code class="highlighter-rouge">nil</code>大除了<code class="highlighter-rouge">nil</code>本身。用户传入的变量如果为<code class="highlighter-rouge">null</code>,将自动以<code class="highlighter-rouge">nil</code>替代。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"nil == nil"</span><span class="o">);</span>   <span class="c1">//true</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" 3&gt; nil"</span><span class="o">);</span>      <span class="c1">//true</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" true!= nil"</span><span class="o">);</span>  <span class="c1">//true</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" ' '&gt;nil "</span><span class="o">);</span>    <span class="c1">//true</span>
<span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">" a==nil "</span><span class="o">);</span>     <span class="c1">//true, a 是 null</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">nil</code>与<code class="highlighter-rouge">String</code>相加的时候,跟 java 一样显示为 <code class="highlighter-rouge">null</code></p>

<h3 id="日期比较">日期比较</h3>

<p>Aviator 并不支持日期类型,如果要比较日期,你需要将日期写字符串的形式,并且要求是形如 “yyyy-MM-dd HH:mm:ss:SS”的字符串,否则都将报错。 字符串跟<code class="highlighter-rouge">java.util.Date</code>比较的时候将自动转换为<code class="highlighter-rouge">Date</code>对象进行比较:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
    <span class="kd">final</span> <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">dateStr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss:SS"</span><span class="o">).</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"date"</span><span class="o">,</span> <span class="n">date</span><span class="o">);</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"dateStr"</span><span class="o">,</span> <span class="n">dateStr</span><span class="o">);</span>
    <span class="n">Boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"date==dateStr"</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// true</span>
    <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"date &gt; '2010-12-20 00:00:00:00' "</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// true</span>
    <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"date &lt; '2200-12-20 00:00:00:00' "</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// true</span>
    <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"date==date "</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// true</span>
<span class="o">}</span>
</code></pre></div></div>

<p>也就是说<code class="highlighter-rouge">String</code>除了能跟<code class="highlighter-rouge">String</code>比较之外,还能跟<code class="highlighter-rouge">nil</code>和<code class="highlighter-rouge">java.util.Date</code>对象比较。</p>

<h3 id="大数计算和精度">大数计算和精度</h3>

<p>从 2.3.0 版本开始,aviator 开始支持大数字计算和特定精度的计算, 本质上就是支持<code class="highlighter-rouge">java.math.BigInteger</code>和<code class="highlighter-rouge">java.math.BigDecimal</code>两种类型, 这两种类型在 aviator 中简称
为<code class="highlighter-rouge">big int</code>和<code class="highlighter-rouge">decimal</code>类型。
类似<code class="highlighter-rouge">99999999999999999999999999999999</code>这样的数字在 Java 语言里是没办法编译通过 的, 因为它超过了<code class="highlighter-rouge">Long</code>类型的范围, 只能用<code class="highlighter-rouge">BigInteger</code>来封装。但是 aviator 通过包装,可 以直接支持这种大整数的计算,例如:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"99999999999999999999999999999999 + 99999999999999999999999999999999"</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>结果为类型<code class="highlighter-rouge">big int</code>的: <code class="highlighter-rouge">199999999999999999999999999999998</code></p>

<h4 id="字面量表示">字面量表示</h4>

<p><code class="highlighter-rouge">big int</code>和<code class="highlighter-rouge">decimal</code>的表示与其他数字不同,两条规则:</p>

<ul>
  <li>以大写字母<code class="highlighter-rouge">N</code>为后缀的整数都被认为是<code class="highlighter-rouge">big int</code>,如<code class="highlighter-rouge">1N,2N,9999999999999999999999N</code>等, 都是<code class="highlighter-rouge">big int</code>类型。</li>
  <li>超过<code class="highlighter-rouge">long</code>范围的整数字面量都将自动转换为<code class="highlighter-rouge">big int</code>类型。</li>
  <li>以大写字母<code class="highlighter-rouge">M</code>为后缀的数字都被认为是<code class="highlighter-rouge">decimal</code>, 如<code class="highlighter-rouge">1M,2.222M, 100000.9999M</code>等, 都是<code class="highlighter-rouge">decimal</code>类型。</li>
</ul>

<p>用户也可以通过变量传入这两种类型来参与计算。</p>

<h4 id="运算">运算</h4>

<p><code class="highlighter-rouge">big int</code>和<code class="highlighter-rouge">decimal</code>的运算,跟其他数字类型<code class="highlighter-rouge">long,double</code>没有什么区别,操作符仍然是一样的。 aviator重载了基本算术操作符来支持这两种新类型:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"9223372036854775807100.356M * 2"</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rt</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">rt</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>  <span class="c1">// 18446744073709551614200.712 class java.math.BigDecimal</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"92233720368547758074+1000"</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rt</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">rt</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>  <span class="c1">// 92233720368547759074 class java.math.BigInteger</span>
    <span class="n">BigInteger</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigInteger</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">)</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">));</span>
    <span class="n">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="s">"3.2"</span><span class="o">);</span>
    <span class="n">BigDecimal</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigDecimal</span><span class="o">(</span><span class="s">"9999.99999"</span><span class="o">);</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"a+10000000000000000000"</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rt</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">rt</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>  <span class="c1">// 92233720368547758089223372036854775807 class java.math.BigInteger</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"b+c*2"</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rt</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">rt</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>  <span class="c1">// 20003.19998 class java.math.BigDecimal</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"a*b/c"</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">rt</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">rt</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>  <span class="c1">// 2.951479054745007313280155218459508E+34 class java.math.BigDecimal</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="类型转换和提升">类型转换和提升</h4>

<p>当<code class="highlighter-rouge">big int</code>或者<code class="highlighter-rouge">decimal</code>和其他类型的数字做运算的时候,按照<code class="highlighter-rouge">long &lt; big int &lt; decimal &lt; double</code>的规则做提升, 也就是说运算的数字如果类型不一致, 结果的类型为两者之间更“高”的类型。例如:</p>

<ul>
  <li><code class="highlighter-rouge">1 + 3N</code>, 结果为<code class="highlighter-rouge">big int</code>的<code class="highlighter-rouge">4N</code></li>
  <li><code class="highlighter-rouge">1 + 3.1M</code>,结果为<code class="highlighter-rouge">decimal</code>的<code class="highlighter-rouge">4.1M</code></li>
  <li><code class="highlighter-rouge">1N + 3.1M</code>,结果为<code class="highlighter-rouge">decimal</code>的 <code class="highlighter-rouge">4.1M</code></li>
  <li><code class="highlighter-rouge">1.0 + 3N</code>,结果为<code class="highlighter-rouge">double</code>的<code class="highlighter-rouge">4.0</code></li>
  <li><code class="highlighter-rouge">1.0 + 3.1M</code>,结果为<code class="highlighter-rouge">double</code>的<code class="highlighter-rouge">4.1</code></li>
</ul>

<h4 id="decimal-的计算精度">decimal 的计算精度</h4>

<p>Java 的<code class="highlighter-rouge">java.math.BigDecimal</code>通过<code class="highlighter-rouge">java.math.MathContext</code>支持特定精度的计算,任何涉及到金额的计算都应该使用<code class="highlighter-rouge">decimal</code>类型。</p>

<p>默认 Aviator 的计算精度为<code class="highlighter-rouge">MathContext.DECIMAL128</code>,你可以自定义精度, 通过:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">setMathContext</span><span class="o">(</span><span class="n">MathContext</span><span class="o">.</span><span class="na">DECIMAL64</span><span class="o">);</span>
</code></pre></div></div>

<p>即可设置,更多关于<code class="highlighter-rouge">decimal</code>的精度问题请看<code class="highlighter-rouge">java.math.BigDecimal</code>的 javadoc 文档。</p>

<h3 id="强大的-seq-库">强大的 seq 库</h3>

<p>aviator 拥有强大的操作集合和数组的 <code class="highlighter-rouge">seq</code> 库。整个库风格类似函数式编程中的高阶函数。在 aviator 中, 数组以及<code class="highlighter-rouge">java.util.Collection</code>下的子类都称为<code class="highlighter-rouge">seq</code>,可以直接利用 <code class="highlighter-rouge">seq</code> 库进行遍历、过滤和聚合等操作。</p>

<p>例如,假设我有个 <code class="highlighter-rouge">list</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="n">env</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"list"</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"count(list)"</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// 3</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"reduce(list,+,0)"</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// 33</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"filter(list,seq.gt(9))"</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// [10, 20]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"include(list,10)"</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// true</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"sort(list)"</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// [3, 10, 20]</span>
    <span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"map(list,println)"</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们可以:</p>

<ul>
  <li>求长度: <code class="highlighter-rouge">count(list)</code></li>
  <li>求和: <code class="highlighter-rouge">reduce(list,+,0)</code>, <code class="highlighter-rouge">reduce</code>函数接收三个参数,第一个是<code class="highlighter-rouge">seq</code>,第二个是聚合的函数,如<code class="highlighter-rouge">+</code>等,第三个是聚合的初始值</li>
  <li>过滤: <code class="highlighter-rouge">filter(list,seq.gt(9))</code>, 过滤出<code class="highlighter-rouge">list</code>中所有大于<code class="highlighter-rouge">9</code>的元素并返回集合; <code class="highlighter-rouge">seq.gt</code>函数用于生成一个谓词,表示大于某个值</li>
  <li>判断元素在不在集合里: <code class="highlighter-rouge">include(list,10)</code></li>
  <li>排序: <code class="highlighter-rouge">sort(list)</code></li>
  <li>遍历整个集合: <code class="highlighter-rouge">map(list,println)</code>, <code class="highlighter-rouge">map</code>接受的第二个函数将作用于集合中的每个元素,这里简单地调用<code class="highlighter-rouge">println</code>打印每个元素</li>
</ul>

<h3 id="两种运行模式">两种运行模式</h3>

<p>默认 <code class="highlighter-rouge">AviatorEvaluator</code> 以执行速度优先:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">setOptimize</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">EVAL</span><span class="o">);</span>
</code></pre></div></div>

<p>你可以修改为编译速度优先,这样不会做编译优化:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">setOptimize</span><span class="o">(</span><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">COMPILE</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="调试信息">调试信息</h3>

<p>从 2.1.1.版本开始,Aviator允许设置输出每个表达式生成的字节码,只要设置<code class="highlighter-rouge">trace</code>为<code class="highlighter-rouge">true</code>即可:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">setTrace</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre></div></div>

<p>方便用户做跟踪和调试。默认是输出到标准输出,你可以改变输出指向:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AviatorEvaluator</span><span class="o">.</span><span class="na">setTraceOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"aviator.log"</span><span class="o">)));</span>
</code></pre></div></div>

<h2 id="语法手册">语法手册</h2>

<p>下面是 Aviator 详细的语法规则定义。</p>

<h3 id="数据类型">数据类型</h3>

<ul>
  <li><code class="highlighter-rouge">Number</code>类型: 数字类型,支持四种类型,分别是<code class="highlighter-rouge">long,double,java.math.BigInteger(简称 big int)</code>和<code class="highlighter-rouge">java.math.BigDecimal(简
称 decimal)</code>,规则如下:
    <ul>
      <li>任何以大写字母 <code class="highlighter-rouge">N</code> 结尾的整数都被认为是 <code class="highlighter-rouge">big int</code></li>
      <li>任何以大写字母 <code class="highlighter-rouge">M</code> 结尾的数字都被认为是 <code class="highlighter-rouge">decimal</code></li>
      <li>其他的任何整数都将被转换为 <code class="highlighter-rouge">Long</code></li>
      <li>其他任何浮点数都将被转换为 <code class="highlighter-rouge">Double</code></li>
      <li>超过 <code class="highlighter-rouge">long</code> 范围的整数字面量都将自动转换为 <code class="highlighter-rouge">big int</code> 类型</li>
    </ul>
  </li>
</ul>

<p>其中 <code class="highlighter-rouge">big int</code> 和 <code class="highlighter-rouge">decimal</code> 是 2.3.0 版本开始引入的。数字还支持十六进制(以<code class="highlighter-rouge">0x</code>或者<code class="highlighter-rouge">0X</code>开头的数字), 以及科学计数法,如<code class="highlighter-rouge">1e-3</code>等。 不支持其他进制。</p>

<ul>
  <li><code class="highlighter-rouge">String</code>类型: 字符串类型,单引号或者双引号括起来的文本串,如<code class="highlighter-rouge">'hello world'</code>, 变量如果传入的是<code class="highlighter-rouge">String</code>或者<code class="highlighter-rouge">Character</code>也将转为<code class="highlighter-rouge">String</code>类型</li>
  <li><code class="highlighter-rouge">Bool</code>类型: 常量<code class="highlighter-rouge">true</code>和<code class="highlighter-rouge">false</code>,表示真值和假值,与 java 的<code class="highlighter-rouge">Boolean.TRUE</code>和<code class="highlighter-rouge">Boolean.False</code>对应</li>
  <li><code class="highlighter-rouge">Pattern</code>类型: 正则表达式, 以<code class="highlighter-rouge">//</code>括起来的字符串,如<code class="highlighter-rouge">/\d+/</code>,内部 实现为<code class="highlighter-rouge">java.util.Pattern</code></li>
  <li>变量类型: 与 Java 的变量命名规则相同,变量的值由用户传入</li>
  <li><code class="highlighter-rouge">nil</code>类型: 常量<code class="highlighter-rouge">nil</code>,类似 java 中的<code class="highlighter-rouge">null</code>,但是<code class="highlighter-rouge">nil</code>比较特殊,<code class="highlighter-rouge">nil</code>不仅可以参与<code class="highlighter-rouge">==、!=</code>的比较, 也可以参与<code class="highlighter-rouge">&gt;、&gt;=、&lt;、&lt;=</code>的比较,Aviator 规定任何类型都大于<code class="highlighter-rouge">nil</code>除了<code class="highlighter-rouge">nil</code>本身,<code class="highlighter-rouge">nil==nil</code>返回<code class="highlighter-rouge">true</code>。 用户传入的变量值如果为<code class="highlighter-rouge">null</code>,那么也将作为<code class="highlighter-rouge">nil</code>处理,<code class="highlighter-rouge">nil</code>打印为<code class="highlighter-rouge">null</code></li>
</ul>

<h3 id="操作符">操作符</h3>

<h4 id="算术运算符">算术运算符</h4>

<p>Aviator 支持常见的算术运算符,包括<code class="highlighter-rouge">+ - * / %</code>五个二元运算符,和一元运算符<code class="highlighter-rouge">-(负)</code>。其中<code class="highlighter-rouge">- * / %</code>和一元的<code class="highlighter-rouge">-</code>仅能作用于<code class="highlighter-rouge">Number</code>类型。<br />
<code class="highlighter-rouge">+</code>不仅能用于<code class="highlighter-rouge">Number</code>类型,还可以用于<code class="highlighter-rouge">String</code>的相加,或者字符串与其他对象的相加。<br />
Aviator 规定,任何类型与<code class="highlighter-rouge">String</code>相加,结果为<code class="highlighter-rouge">String</code>。</p>

<h4 id="逻辑运算符">逻辑运算符</h4>

<p>Avaitor 的支持的逻辑运算符包括,一元否定运算符<code class="highlighter-rouge">!</code>,以及逻辑与的<code class="highlighter-rouge">&amp;&amp;</code>,逻辑或的<code class="highlighter-rouge">||</code>。逻辑运算符的操作数只能为<code class="highlighter-rouge">Boolean</code>。<br />
<code class="highlighter-rouge">&amp;&amp;</code>和<code class="highlighter-rouge">||</code>都执行短路规则。</p>

<h4 id="关系运算符">关系运算符</h4>

<p>Aviator 支持的关系运算符包括<code class="highlighter-rouge">&lt;, &lt;=, &gt;, &gt;=</code>以及<code class="highlighter-rouge">==</code>和<code class="highlighter-rouge">!=</code> 。<br />
关系运算符可以作用于<code class="highlighter-rouge">Number</code>之间、<code class="highlighter-rouge">String</code>之间、<code class="highlighter-rouge">Pattern</code>之间、<code class="highlighter-rouge">Boolean</code>之间、变量之间以及其他类型与<code class="highlighter-rouge">nil</code>之间的关系比较, 不同类型除了<code class="highlighter-rouge">nil</code>之外不能相互比较。</p>

<h4 id="位运算符">位运算符</h4>

<p>Aviator 支持所有的 Java 位运算符,包括<code class="highlighter-rouge">&amp;, |, ^, ~, &gt;&gt;, &lt;&lt;, &gt;&gt;&gt;</code>。</p>

<h4 id="匹配运算符">匹配运算符</h4>

<p>匹配运算符<code class="highlighter-rouge">=~</code>用于<code class="highlighter-rouge">String</code>和<code class="highlighter-rouge">Pattern</code>的匹配,它的左操作数必须为<code class="highlighter-rouge">String</code>,右操作数必须为<code class="highlighter-rouge">Pattern</code>。 匹配成功后,<code class="highlighter-rouge">Pattern</code>的分组将存于变量<code class="highlighter-rouge">$num</code>,<code class="highlighter-rouge">num</code>为分组索引。</p>

<h4 id="三元运算符">三元运算符</h4>
<p>Aviator 没有提供<code class="highlighter-rouge">if else</code>语句,但是提供了三元运算符<code class="highlighter-rouge">?:</code>,形式为<code class="highlighter-rouge">bool ? exp1: exp2</code>。 其中<code class="highlighter-rouge">bool</code>必须为<code class="highlighter-rouge">Boolean</code>类型的表达式, 而<code class="highlighter-rouge">exp1</code>和<code class="highlighter-rouge">exp2</code>可以为任何合法的 Aviator 表达式,并且不要求<code class="highlighter-rouge">exp1</code>和<code class="highlighter-rouge">exp2</code>返回的结果类型一致。</p>

<h2 id="内置函数">内置函数</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">函数名称</th>
      <th style="text-align: left">说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">sysdate()</td>
      <td style="text-align: left">返回当前日期对象 java.util.Date</td>
    </tr>
    <tr>
      <td style="text-align: left">rand()</td>
      <td style="text-align: left">返回一个介于 0-1 的随机数,double 类型</td>
    </tr>
    <tr>
      <td style="text-align: left">print([out],obj)</td>
      <td style="text-align: left">打印对象,如果指定 out,向 out 打印, 否则输出到控制台</td>
    </tr>
    <tr>
      <td style="text-align: left">println([out],obj)</td>
      <td style="text-align: left">与 print 类似,但是在输出后换行</td>
    </tr>
    <tr>
      <td style="text-align: left">now()</td>
      <td style="text-align: left">返回 System.currentTimeMillis</td>
    </tr>
    <tr>
      <td style="text-align: left">long(v)</td>
      <td style="text-align: left">将值的类型转为 long</td>
    </tr>
    <tr>
      <td style="text-align: left">double(v)</td>
      <td style="text-align: left">将值的类型转为 double</td>
    </tr>
    <tr>
      <td style="text-align: left">str(v)</td>
      <td style="text-align: left">将值的类型转为 string</td>
    </tr>
    <tr>
      <td style="text-align: left">date_to_string(date,format)</td>
      <td style="text-align: left">将 Date 对象转化化特定格式的字符串,2.1.1 新增</td>
    </tr>
    <tr>
      <td style="text-align: left">string_to_date(source,format)</td>
      <td style="text-align: left">将特定格式的字符串转化为 Date 对 象,2.1.1 新增</td>
    </tr>
    <tr>
      <td style="text-align: left">string.contains(s1,s2)</td>
      <td style="text-align: left">判断 s1 是否包含 s2,返回 Boolean</td>
    </tr>
    <tr>
      <td style="text-align: left">string.length(s)</td>
      <td style="text-align: left">求字符串长度,返回 Long</td>
    </tr>
    <tr>
      <td style="text-align: left">string.startsWith(s1,s2)</td>
      <td style="text-align: left">s1 是否以 s2 开始,返回 Boolean</td>
    </tr>
    <tr>
      <td style="text-align: left">string.endsWith(s1,s2)</td>
      <td style="text-align: left">s1 是否以 s2 结尾,返回 Boolean</td>
    </tr>
    <tr>
      <td style="text-align: left">string.substring(s,begin[,end])</td>
      <td style="text-align: left">截取字符串 s,从 begin 到 end,如果忽略 end 的话,将从 begin 到结尾,与 java.util.String.substring 一样。</td>
    </tr>
    <tr>
      <td style="text-align: left">string.indexOf(s1,s2)</td>
      <td style="text-align: left">java 中的 s1.indexOf(s2),求 s2 在 s1 中 的起始索引位置,如果不存在为-1</td>
    </tr>
    <tr>
      <td style="text-align: left">string.split(target,regex,[limit])</td>
      <td style="text-align: left">Java 里的 String.split 方法一致,2.1.1 新增函数</td>
    </tr>
    <tr>
      <td style="text-align: left">string.join(seq,seperator)</td>
      <td style="text-align: left">将集合 seq 里的元素以 seperator 为间隔 连接起来形成字符串,2.1.1 新增函数</td>
    </tr>
    <tr>
      <td style="text-align: left">string.replace_first(s,regex,replacement)</td>
      <td style="text-align: left">Java 里的 String.replaceFirst 方法, 2.1.1 新增</td>
    </tr>
    <tr>
      <td style="text-align: left">string.replace_all(s,regex,replacement)</td>
      <td style="text-align: left">Java 里的 String.replaceAll 方法 , 2.1.1 新增</td>
    </tr>
    <tr>
      <td style="text-align: left">math.abs(d)</td>
      <td style="text-align: left">求 d 的绝对值</td>
    </tr>
    <tr>
      <td style="text-align: left">math.sqrt(d)</td>
      <td style="text-align: left">求 d 的平方根</td>
    </tr>
    <tr>
      <td style="text-align: left">math.pow(d1,d2)</td>
      <td style="text-align: left">求 d1 的 d2 次方</td>
    </tr>
    <tr>
      <td style="text-align: left">math.log(d)</td>
      <td style="text-align: left">求 d 的自然对数</td>
    </tr>
    <tr>
      <td style="text-align: left">math.log10(d)</td>
      <td style="text-align: left">求 d 以 10 为底的对数</td>
    </tr>
    <tr>
      <td style="text-align: left">math.sin(d)</td>
      <td style="text-align: left">正弦函数</td>
    </tr>
    <tr>
      <td style="text-align: left">math.cos(d)</td>
      <td style="text-align: left">余弦函数</td>
    </tr>
    <tr>
      <td style="text-align: left">math.tan(d)</td>
      <td style="text-align: left">正切函数</td>
    </tr>
    <tr>
      <td style="text-align: left">map(seq,fun)</td>
      <td style="text-align: left">将函数 fun 作用到集合 seq 每个元素上, 返回新元素组成的集合</td>
    </tr>
    <tr>
      <td style="text-align: left">filter(seq,predicate)</td>
      <td style="text-align: left">将谓词 predicate 作用在集合的每个元素 上,返回谓词为 true 的元素组成的集合</td>
    </tr>
    <tr>
      <td style="text-align: left">count(seq)</td>
      <td style="text-align: left">返回集合大小</td>
    </tr>
    <tr>
      <td style="text-align: left">include(seq,element)</td>
      <td style="text-align: left">判断 element 是否在集合 seq 中,返回 boolean 值</td>
    </tr>
    <tr>
      <td style="text-align: left">sort(seq)</td>
      <td style="text-align: left">排序集合,仅对数组和 List 有效,返回排 序后的新集合</td>
    </tr>
    <tr>
      <td style="text-align: left">reduce(seq,fun,init)</td>
      <td style="text-align: left">fun 接收两个参数,第一个是集合元素, 第二个是累积的函数,本函数用于将 fun 作用在集合每个元素和初始值上面,返回 最终的 init 值</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.eq(value)</td>
      <td style="text-align: left">返回一个谓词,用来判断传入的参数是否跟 value 相等,用于 filter 函数,如filter(seq,seq.eq(3)) 过滤返回等于3 的元素组成的集合</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.neq(value)</td>
      <td style="text-align: left">与 seq.eq 类似,返回判断不等于的谓词</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.gt(value)</td>
      <td style="text-align: left">返回判断大于 value 的谓词</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.ge(value)</td>
      <td style="text-align: left">返回判断大于等于 value 的谓词</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.lt(value)</td>
      <td style="text-align: left">返回判断小于 value 的谓词</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.le(value)</td>
      <td style="text-align: left">返回判断小于等于 value 的谓词</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.nil()</td>
      <td style="text-align: left">返回判断是否为 nil 的谓词</td>
    </tr>
    <tr>
      <td style="text-align: left">seq.exists()</td>
      <td style="text-align: left">返回判断不为 nil 的谓词</td>
    </tr>
  </tbody>
</table>

<h2 id="相关链接">相关链接</h2>

<p><a href="https://github.com/killme2008/aviator">GitHub上的资料</a></p>

<hr />

        </div>
    </div>

    <!-- gitalk评论框 start (一个网页只需插入一次) -->
    <div id="gitalk-container">
        <script type="text/javascript">
            var gitalk = new Gitalk({
                // gitalk的主要参数
                clientID: `9dc0d8d7df27d927c04e`,
                clientSecret: `48882a3ff7b351d89e7e67b4c61c7301d64afca2`,
                repo: `rgkjhshi.github.io`,
                owner: 'rgkjhshi',
                admin: ['rgkjhshi'],
                id: '表达式引擎aviator',
            });
            gitalk.render('gitalk-container');
        </script>
    </div>
    <!-- gitalk评论框 end -->
</div>

  </div>

  <!-- 回到顶部 -->
  <div class="page-scrollTop" data-toggle="tooltip" data-placement="top" title="Top">
    <a href="javascript:void(0);">
      <div class="arrow"></div>
      <div class="stick"></div>
    </a>
  </div>

  <footer class="footer">
    <!-- 导航栏 -->
    <div class="uk-container uk-container-center">
        <div class="uk-container footwapper">
            <div class="uk-grid">
                <div class="uk-width-1-3 uk-text-center">
                    <span class="foot-text"> 京ICP备14015515号-1 </span>
                </div>
                <div class="uk-width-1-3 uk-text-center">
                    <span class="foot-text">
                        <a href="http://www.amazingcounters.com"><img border="0" src="http://cc.amazingcounters.com/counter.php?i=3195706&c=9587431" alt="AmazingCounters.com"></a>
                    </span>
                </div>
                <div class="uk-width-1-3 uk-text-center">
                <span class="foot-text"> <i class="uk-icon-copyright"></i>2015 Michael King. </span>
                </div>
                <div class="uk-hidden">
                    <span class="foot-text">
                        <!-- cnzz统计工具 -->
                        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254308303'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1254308303%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script>
                    </span>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- footer end -->


</body>

</html>
